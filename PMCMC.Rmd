# Particle MCMC

Here we will run the ABC-PMCMC routine of Drovandi et al. (2016). This uses the alive particle filter of Jasra et al. (2012). Note that PMCMC is extremely computationally intensive, and the only real way to make it tractable for many problems is to code both the simulation code and the MCMC code in a low-level language such as C. The `SimBIID` package provides a function `PMCMC()` that runs this algorithm, and if you pass a `SimBIID_model` object to this function, it will automatically compile in the correct manner.

The other thing is that we will be matching at a set of given time points, so we cannot add a `tspan` argument. Rather, this will be determined by the `data` that we pass to `PMCMC()`.

```{r}
## set up model to compile to an XPtr object
model <- mparseRcpp(
    transitions = transitions, 
    compartments = compartments,
    pars = pars
)
```

Here we will match to the $B$ curve using the same tolerance at each time point. Therefore we must set up a `data.frame` with the first column labelled `time`, and then each other column being the data to match to.

```{r}
## set up data to match to
BS_dat <- BS[, c(4, 2)]
colnames(BS_dat)[1] <- "time"
BS_dat$time <- BS_dat$time - 1
BS_dat
```

Now we run the ABC-PMCMC algorithm for 2,000 iterations, using 50 particles and a tolerance of $\pm 50$ at each time point. We pass the same initial states and priors as in the ABC-SMC practical.

```{r}
## set tolerances
tols <- data.frame(B = 50)
    
## run PMCMC algorithm
BS_mcmc <- PMCMC(BS_dat, priors, model, iniStates,
                 npart = 50, tols = tols, niter = 1000)
```

We can visualise the MCMC chain and the approximate posterior distributions:

```{r}
## plot MCMC output
plot(BS_mcmc, "trace")
plot(BS_mcmc)
```

We may now want to run the chains for a bit longer. We can do this simply by passing our current `PMCMC` object back into the `PMCMC()` function:

```{r}
## run for a bit longer
BS_mcmc <- PMCMC(BS_mcmc, niter = 1000)
```

```{r}
## plot MCMC output
plot(BS_mcmc, "trace")
```

This is an approximation, but is based around matching to more data points.

```{task}
Re-run the code but this time matching to both the $B$ and $C$ curves. This can be done by amending `BS_dat`.
```

```{solution}

``{r}
## set up data to match to
BS_dat <- BS[, c(4, 2, 3)]
colnames(BS_dat)[1] <- "time"
BS_dat$time <- BS_dat$time - 1
head(BS_dat)
``

``{r}
## set tolerances
tols <- data.frame(B = 100, C = 100)

## run PMCMC algorithm
BS_mcmc <- PMCMC(BS_dat, priors, model, iniStates,
                 npart = 50, tols = tols, niter = 1000)

## plot traces
plot(BS_mcmc, "trace")
``

```
